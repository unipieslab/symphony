#!/bin/bash

# Example runs:
# ./voltset PMD 950
# ./voltset SOC 920
# ./voltset ALL 950 920
echo "Setting voltage"
I2C_IN=1
i2cget -y ${I2C_IN} 0x2f 0x34 w &>/dev/null
[ $? -ne 0 ] && I2C_IN=0

PMD_NOMINAL=980
SOC_NOMINAL=950
VOLT_STEP=5
SLEEP_TIME=5
VD=$1
VOLT_START=$2


if [[ "$VD" = "PMD" ]]; then
        CURR_VOLT=$PMD_NOMINAL
        if [ $VOLT_START -eq $PMD_NOMINAL ]; then
                i2cset -y ${I2C_IN} 0x2f 0x34 $(printf "%#06x" $VOLT_START) w
		#echo $VOLT_START
                sleep $SLEEP_TIME;
        else
                while [ $CURR_VOLT -gt $VOLT_START ];
                do
                        let CURR_VOLT=CURR_VOLT-VOLT_STEP
                        i2cset -y ${I2C_IN} 0x2f 0x34 $(printf "%#06x" $CURR_VOLT) w
			#echo $CURR_VOLT
                        sleep $SLEEP_TIME;
                done;
        fi;
elif [[ "$VD" = "SOC" ]]; then
        CURR_VOLT=$SOC_NOMINAL
        if [ $VOLT_START -eq $SOC_NOMINAL ]; then
                i2cset -y ${I2C_IN} 0x2f 0x35 $(printf "%#06x" $VOLT_START) w
		#echo $VOLT_START
                sleep $SLEEP_TIME;
        else
                while [ $CURR_VOLT -gt $VOLT_START ];
                do
                        let CURR_VOLT=CURR_VOLT-VOLT_STEP
                        i2cset -y ${I2C_IN} 0x2f 0x35 $(printf "%#06x" $CURR_VOLT) w
			#echo $CURR_VOLT
                        sleep $SLEEP_TIME;
                done;
        fi;
else
        CURR_VOLT=$PMD_NOMINAL
        if [ $VOLT_START -eq $PMD_NOMINAL ]; then
                i2cset -y ${I2C_IN} 0x2f 0x34 $(printf "%#06x" $VOLT_START) w
                sleep $SLEEP_TIME;
                i2cset -y ${I2C_IN} 0x2f 0x35 $(printf "%#06x" $((VOLT_START-PMD_NOMINAL+SOC_NOMINAL))) w
                sleep $SLEEP_TIME;
        else
                while [ $CURR_VOLT -gt $VOLT_START ];
                do
                        let CURR_VOLT=CURR_VOLT-VOLT_STEP
                        i2cset -y ${I2C_IN} 0x2f 0x34 $(printf "%#06x" $CURR_VOLT) w
			#echo $CURR_VOLT
                        sleep $SLEEP_TIME;
			lala=$(echo "($CURR_VOLT-$PMD_NOMINAL)/2" | bc)
                        i2cset -y ${I2C_IN} 0x2f 0x35 $( printf "%#06x" $((SOC_NOMINAL+lala)) ) w
			#echo $((SOC_NOMINAL+lala))
                        sleep $SLEEP_TIME;
                done;
        fi;
fi;
echo "You're ready to go..."
